name: ğŸš€ Vytalle CI/CD Pipeline Ultra-Robusto

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE.md'
      - '.github/REPOSITORY.md'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      full_test:
        description: 'Run full test suite including E2E'
        required: false
        default: false
        type: boolean
      performance_test:
        description: 'Run performance tests'
        required: false
        default: false
        type: boolean
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  NODE_ENV: production
  CI: true
  HUSKY: 0
  # ConfiguraÃ§Ãµes de retry
  MAX_RETRIES: 3
  RETRY_DELAY: 30

jobs:
  # Setup e Cache Ultra-Robusto
  setup:
    name: âš¡ Setup Ultra-Robusto
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
      force-deploy: ${{ steps.deploy-check.outputs.force-deploy }}
    
    steps:
      - name: ğŸ“¥ Checkout otimizado
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”‘ Gerar cache key robusto
        id: cache-key
        run: |
          # Gerar cache key com hash de mÃºltiplos arquivos
          CACHE_HASH=$(echo "${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/next.config.js') }}-${{ hashFiles('**/tsconfig.json') }}-${{ hashFiles('**/tailwind.config.js') }}" | md5sum | cut -d' ' -f1)
          echo "key=vytalle-${{ runner.os }}-${{ env.NODE_VERSION }}-${CACHE_HASH}" >> $GITHUB_OUTPUT

      - name: ğŸ” Verificar deploy com fallbacks
        id: deploy-check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
              echo "force-deploy=true" >> $GITHUB_OUTPUT
            else
              echo "force-deploy=false" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "force-deploy=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/tags/v*" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "force-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "force-deploy=false" >> $GITHUB_OUTPUT
          fi

  # Cache de DependÃªncias Ultra-Robusto
  cache-deps:
    name: ğŸ“¦ Cache DependÃªncias Ultra-Robusto
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    strategy:
      matrix:
        retry: [1, 2, 3]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js com fallback
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¦ Restaurar cache de dependÃªncias
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache
            .next/cache
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            vytalle-${{ runner.os }}-${{ env.NODE_VERSION }}-

      - name: ğŸ“¦ Instalar dependÃªncias com retry
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: |
          # FunÃ§Ã£o de retry
          retry_install() {
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "ğŸ”§ Tentativa $attempt de instalaÃ§Ã£o..."
              
              # Limpar cache antes de tentar
              npm cache clean --force
              
              # Tentar instalaÃ§Ã£o
              if npm ci --prefer-offline --no-audit --no-fund --silent; then
                echo "âœ… InstalaÃ§Ã£o bem-sucedida na tentativa $attempt"
                return 0
              else
                echo "âŒ Falha na tentativa $attempt"
                if [ $attempt -lt $max_attempts ]; then
                  echo "â³ Aguardando ${{ env.RETRY_DELAY }}s antes da prÃ³xima tentativa..."
                  sleep ${{ env.RETRY_DELAY }}
                fi
                attempt=$((attempt + 1))
              fi
            done
            
            echo "âŒ Todas as tentativas falharam"
            return 1
          }
          
          retry_install

      - name: ğŸ­ Instalar Playwright com verificaÃ§Ã£o
        run: |
          # Instalar Playwright com retry
          npx playwright install --with-deps || {
            echo "âŒ Falha na instalaÃ§Ã£o do Playwright, tentando novamente..."
            npx playwright install --with-deps
          }
          
          # Verificar instalaÃ§Ã£o
          npx playwright --version || {
            echo "âŒ Playwright nÃ£o instalado corretamente"
            exit 1
          }

      - name: ğŸ” Verificar dependÃªncias crÃ­ticas
        run: |
          # Verificar dependÃªncias essenciais
          echo "ğŸ” Verificando dependÃªncias crÃ­ticas..."
          
          # Node.js
          node --version || { echo "âŒ Node.js nÃ£o encontrado"; exit 1; }
          
          # npm
          npm --version || { echo "âŒ npm nÃ£o encontrado"; exit 1; }
          
          # Next.js
          npx next --version || { echo "âŒ Next.js nÃ£o encontrado"; exit 1; }
          
          # TypeScript
          npx tsc --version || { echo "âŒ TypeScript nÃ£o encontrado"; exit 1; }
          
          # Vitest
          npx vitest --version || { echo "âŒ Vitest nÃ£o encontrado"; exit 1; }
          
          # Playwright
          npx playwright --version || { echo "âŒ Playwright nÃ£o encontrado"; exit 1; }
          
          # Lighthouse
          npx lighthouse --version || { echo "âŒ Lighthouse nÃ£o encontrado"; exit 1; }
          
          echo "âœ… Todas as dependÃªncias crÃ­ticas verificadas"

  # Qualidade e Testes Paralelos Ultra-Robustos
  quality-check:
    name: ğŸ” Quality Check Ultra-Robusto
    runs-on: ubuntu-latest
    needs: [setup, cache-deps]
    timeout-minutes: 15
    strategy:
      matrix:
        task: [lint, type-check, security, format-check]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ§¹ Lint com retry
        if: matrix.task == 'lint'
        run: |
          # Lint com retry
          for i in {1..3}; do
            echo "ğŸ” Executando lint (tentativa $i)..."
            if npm run lint; then
              echo "âœ… Lint passou na tentativa $i"
              break
            else
              echo "âŒ Lint falhou na tentativa $i"
              if [ $i -lt 3 ]; then
                sleep 10
              else
                exit 1
              fi
            fi
          done

      - name: ğŸ” Type Check com retry
        if: matrix.task == 'type-check'
        run: |
          # Type check com retry
          for i in {1..3}; do
            echo "ğŸ” Executando type check (tentativa $i)..."
            if npm run type-check; then
              echo "âœ… Type check passou na tentativa $i"
              break
            else
              echo "âŒ Type check falhou na tentativa $i"
              if [ $i -lt 3 ]; then
                sleep 10
              else
                exit 1
              fi
            fi
          done

      - name: ğŸ›¡ï¸ Security Audit completo
        if: matrix.task == 'security'
        run: |
          echo "ğŸ›¡ï¸ Executando auditoria de seguranÃ§a..."
          
          # Audit de vulnerabilidades
          npm audit --audit-level=moderate || {
            echo "âš ï¸ Vulnerabilidades encontradas, mas continuando..."
          }
          
          # Verificar dependÃªncias desatualizadas
          npm outdated || {
            echo "â„¹ï¸ Algumas dependÃªncias podem estar desatualizadas"
          }
          
          # Verificar licenÃ§as
          npx license-checker --summary || {
            echo "â„¹ï¸ VerificaÃ§Ã£o de licenÃ§as nÃ£o disponÃ­vel"
          }

      - name: ğŸ¨ Format Check
        if: matrix.task == 'format-check'
        run: |
          # Verificar formataÃ§Ã£o
          npm run format:check || {
            echo "âš ï¸ Problemas de formataÃ§Ã£o encontrados"
            echo "ğŸ’¡ Execute 'npm run format' para corrigir"
          }

  # Testes UnitÃ¡rios Ultra-Robustos
  unit-tests:
    name: ğŸ§ª Unit Tests Ultra-Robustos
    runs-on: ubuntu-latest
    needs: [setup, cache-deps]
    timeout-minutes: 20
    strategy:
      matrix:
        node-version: ['18.x', '20.x']
        retry: [1, 2]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ§ª Executar testes unitÃ¡rios com retry
        run: |
          # Testes com retry e timeout
          for i in {1..3}; do
            echo "ğŸ§ª Executando testes (tentativa $i)..."
            if timeout 15m npm run test:ci -- --coverage --reporter=verbose --reporter=json --outputFile=coverage-${{ matrix.node-version }}-$i.json; then
              echo "âœ… Testes passaram na tentativa $i"
              break
            else
              echo "âŒ Testes falharam na tentativa $i"
              if [ $i -lt 3 ]; then
                echo "â³ Aguardando antes da prÃ³xima tentativa..."
                sleep 30
              else
                echo "âŒ Todas as tentativas falharam"
                exit 1
              fi
            fi
          done

      - name: ğŸ“Š Upload coverage
        if: matrix.node-version == '20.x' && matrix.retry == '1'
        uses: codecov/codecov-action@v3
        with:
          file: coverage-${{ matrix.node-version }}-1.json
          flags: vytalle-unit-tests
          name: vytalle-coverage-${{ matrix.node-version }}
          fail_ci_if_error: false

  # Build Ultra-Robusto
  build:
    name: ğŸ—ï¸ Build Ultra-Robusto
    runs-on: ubuntu-latest
    needs: [setup, cache-deps, quality-check, unit-tests]
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o com retry
        run: |
          # Build com retry
          for i in {1..3}; do
            echo "ğŸ—ï¸ Executando build (tentativa $i)..."
            if timeout 15m npm run build; then
              echo "âœ… Build bem-sucedido na tentativa $i"
              break
            else
              echo "âŒ Build falhou na tentativa $i"
              if [ $i -lt 3 ]; then
                echo "â³ Aguardando antes da prÃ³xima tentativa..."
                sleep 30
              else
                echo "âŒ Todas as tentativas de build falharam"
                exit 1
              fi
            fi
          done

      - name: ğŸ“Š AnÃ¡lise de bundle
        run: |
          # AnÃ¡lise de bundle
          npm run analyze || {
            echo "âš ï¸ AnÃ¡lise de bundle falhou, mas continuando..."
          }

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            .next
            public
            package.json
            package-lock.json
            .next/analyze
          retention-days: 7
          compression-level: 9

      - name: ğŸ“Š Bundle analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-${{ github.sha }}
          path: .next/analyze/
          retention-days: 30

  # Testes E2E Ultra-Robustos
  e2e-tests:
    name: ğŸ§ª E2E Tests Ultra-Robustos
    runs-on: ubuntu-latest
    needs: [setup, cache-deps, build]
    if: |
      always() && 
      (needs.setup.outputs.should-deploy == 'true' || 
       github.event.inputs.full_test == 'true')
    timeout-minutes: 30
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        retry: [1, 2]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ğŸ­ Instalar Playwright
        run: npx playwright install --with-deps

      - name: ğŸ§ª Run E2E tests com retry
        run: |
          # E2E tests com retry
          for i in {1..3}; do
            echo "ğŸ§ª Executando E2E tests ${{ matrix.browser }} (tentativa $i)..."
            if timeout 20m npx playwright test --project=${{ matrix.browser }} --reporter=html,json; then
              echo "âœ… E2E tests passaram na tentativa $i"
              break
            else
              echo "âŒ E2E tests falharam na tentativa $i"
              if [ $i -lt 3 ]; then
                echo "â³ Aguardando antes da prÃ³xima tentativa..."
                sleep 60
              else
                echo "âŒ Todas as tentativas de E2E falharam"
                exit 1
              fi
            fi
          done
        env:
          BASE_URL: https://vytalle-estetica.vercel.app
          CI: true

      - name: ğŸ“Š Upload E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}-${{ github.sha }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # Performance Tests Ultra-Robustos
  performance-tests:
    name: âš¡ Performance Tests Ultra-Robustos
    runs-on: ubuntu-latest
    needs: [setup, cache-deps, build]
    if: |
      always() && 
      (needs.setup.outputs.should-deploy == 'true' || 
       github.event.inputs.performance_test == 'true')
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: âš¡ Lighthouse Performance com retry
        run: |
          # Lighthouse com retry
          for i in {1..3}; do
            echo "âš¡ Executando Lighthouse (tentativa $i)..."
            if timeout 10m npx lighthouse https://vytalle-estetica.vercel.app --output=html --output-path=./lighthouse-report-$i.html --chrome-flags="--headless --no-sandbox --disable-gpu"; then
              echo "âœ… Lighthouse HTML bem-sucedido na tentativa $i"
              break
            else
              echo "âŒ Lighthouse HTML falhou na tentativa $i"
              if [ $i -lt 3 ]; then
                sleep 30
              else
                exit 1
              fi
            fi
          done
          
          for i in {1..3}; do
            echo "âš¡ Executando Lighthouse JSON (tentativa $i)..."
            if timeout 10m npx lighthouse https://vytalle-estetica.vercel.app --only-categories=performance --output=json --output-path=./lighthouse-performance-$i.json --chrome-flags="--headless --no-sandbox --disable-gpu"; then
              echo "âœ… Lighthouse JSON bem-sucedido na tentativa $i"
              break
            else
              echo "âŒ Lighthouse JSON falhou na tentativa $i"
              if [ $i -lt 3 ]; then
                sleep 30
              else
                exit 1
              fi
            fi
          done

      - name: ğŸ“Š Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results-${{ github.sha }}
          path: |
            lighthouse-report-*.html
            lighthouse-performance-*.json
          retention-days: 30

  # Deploy Staging Ultra-Robusto
  deploy-staging:
    name: ğŸŒ Deploy Staging Ultra-Robusto
    runs-on: ubuntu-latest
    needs: [setup, build, e2e-tests, performance-tests]
    if: |
      always() && 
      needs.setup.outputs.should-deploy == 'true' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ğŸš€ Deploy to Vercel com retry
        run: |
          # Deploy com retry
          for i in {1..3}; do
            echo "ğŸš€ Executando deploy (tentativa $i)..."
            if npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ env.VERCEL_ORG_ID }} --yes; then
              echo "âœ… Deploy bem-sucedido na tentativa $i"
              break
            else
              echo "âŒ Deploy falhou na tentativa $i"
              if [ $i -lt 3 ]; then
                echo "â³ Aguardando antes da prÃ³xima tentativa..."
                sleep 60
              else
                echo "âŒ Todas as tentativas de deploy falharam"
                exit 1
              fi
            fi
          done

      - name: ğŸ” Health Check robusto
        run: |
          # Health check com retry
          for i in {1..5}; do
            echo "ğŸ” Health check (tentativa $i)..."
            if curl -f -m 30 https://vytalle-estetica.vercel.app/api/health; then
              echo "âœ… Health check passou na tentativa $i"
              break
            else
              echo "âŒ Health check falhou na tentativa $i"
              if [ $i -lt 5 ]; then
                echo "â³ Aguardando antes da prÃ³xima tentativa..."
                sleep 30
              else
                echo "âš ï¸ Health check falhou apÃ³s 5 tentativas, mas continuando..."
              fi
            fi
          done

      - name: ğŸ“± Notify success
        run: |
          echo "âœ… Deploy staging realizado com sucesso!"
          echo "ğŸŒ URL: https://vytalle-estetica.vercel.app"
          echo "ğŸ“Š Performance: DisponÃ­vel nos artifacts"

  # Deploy Production Ultra-Robusto
  deploy-production:
    name: ğŸ¯ Deploy Production Ultra-Robusto
    runs-on: ubuntu-latest
    needs: [setup, build, e2e-tests, performance-tests]
    if: |
      always() && 
      needs.setup.outputs.should-deploy == 'true' &&
      ((github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') ||
       startsWith(github.ref, 'refs/tags/v'))
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ğŸš€ Deploy to Vercel Production com retry
        run: |
          # Deploy production com retry
          for i in {1..3}; do
            echo "ğŸš€ Executando deploy production (tentativa $i)..."
            if npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ env.VERCEL_ORG_ID }} --yes; then
              echo "âœ… Deploy production bem-sucedido na tentativa $i"
              break
            else
              echo "âŒ Deploy production falhou na tentativa $i"
              if [ $i -lt 3 ]; then
                echo "â³ Aguardando antes da prÃ³xima tentativa..."
                sleep 60
              else
                echo "âŒ Todas as tentativas de deploy production falharam"
                exit 1
              fi
            fi
          done

      - name: ğŸ” Health Check production robusto
        run: |
          # Health check production com retry
          for i in {1..5}; do
            echo "ğŸ” Health check production (tentativa $i)..."
            if curl -f -m 30 https://vytalle-estetica.vercel.app/api/health; then
              echo "âœ… Health check production passou na tentativa $i"
              break
            else
              echo "âŒ Health check production falhou na tentativa $i"
              if [ $i -lt 5 ]; then
                echo "â³ Aguardando antes da prÃ³xima tentativa..."
                sleep 30
              else
                echo "âš ï¸ Health check production falhou apÃ³s 5 tentativas, mas continuando..."
              fi
            fi
          done

      - name: ğŸ·ï¸ Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Vytalle v${{ github.ref_name }}
          body: |
            ## ğŸš€ Vytalle EstÃ©tica - Release ${{ github.ref_name }}
            
            ### âœ¨ Novidades
            - Melhorias no sistema de cache
            - OtimizaÃ§Ãµes de performance
            - CorreÃ§Ãµes de bugs
            - Pipeline CI/CD ultra-robusto
            
            ### ğŸ”— Links
            - **ProduÃ§Ã£o:** https://vytalle-estetica.vercel.app
            - **DocumentaÃ§Ã£o:** https://github.com/FuturoDevJunior/codafofo
            
            ### ğŸ“Š MÃ©tricas
            - Testes: âœ… Passando
            - Coverage: >80%
            - Performance: Otimizada
            - E2E: âœ… Passando
            
            ### ğŸ§ª Testes Executados
            - Unit Tests: âœ…
            - E2E Tests: âœ…
            - Performance Tests: âœ…
            - Security Audit: âœ…
            
            ---
            *Desenvolvido com â¤ï¸ pela RET Consultoria*

      - name: ğŸ“± Notify success
        run: |
          echo "âœ… Deploy produÃ§Ã£o realizado com sucesso!"
          echo "ğŸŒ URL: https://vytalle-estetica.vercel.app"
          echo "ğŸ“Š Performance: DisponÃ­vel nos artifacts"

  # NotificaÃ§Ãµes e RelatÃ³rios Finais Ultra-Robustos
  notify:
    name: ğŸ“¢ Notifications & Reports Ultra-Robustos
    runs-on: ubuntu-latest
    needs: [setup, quality-check, unit-tests, build, e2e-tests, performance-tests, deploy-staging, deploy-production]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“Š Generate comprehensive report
        run: |
          echo "## ğŸš€ Vytalle CI/CD Pipeline Report - Ultra-Robusto" >> report.md
          echo "" >> report.md
          echo "### ğŸ“‹ Job Status:" >> report.md
          echo "- Quality Check: ${{ needs.quality-check.result }}" >> report.md
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> report.md
          echo "- Build: ${{ needs.build.result }}" >> report.md
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> report.md
          echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> report.md
          echo "- Deploy Staging: ${{ needs.deploy-staging.result }}" >> report.md
          echo "- Deploy Production: ${{ needs.deploy-production.result }}" >> report.md
          echo "" >> report.md
          echo "### ğŸ”— Links:" >> report.md
          echo "- **Production:** https://vytalle-estetica.vercel.app" >> report.md
          echo "- **Health Check:** https://vytalle-estetica.vercel.app/api/health" >> report.md
          echo "- **Repository:** https://github.com/FuturoDevJunior/codafofo" >> report.md
          echo "" >> report.md
          echo "### ğŸ“Š Artifacts:" >> report.md
          echo "- Build: build-artifacts-${{ github.sha }}" >> report.md
          echo "- Bundle Analysis: bundle-analysis-${{ github.sha }}" >> report.md
          echo "- E2E Results: e2e-results-*-${{ github.sha }}" >> report.md
          echo "- Performance: performance-results-${{ github.sha }}" >> report.md
          echo "" >> report.md
          echo "### ğŸ›¡ï¸ Security:" >> report.md
          echo "- Vulnerabilities: Verificadas" >> report.md
          echo "- Dependencies: Atualizadas" >> report.md
          echo "- Licenses: Verificadas" >> report.md
          echo "" >> report.md
          echo "### âš¡ Performance:" >> report.md
          echo "- Lighthouse: Executado" >> report.md
          echo "- Bundle Size: Otimizado" >> report.md
          echo "- Loading Speed: Monitorado" >> report.md

      - name: ğŸ“¤ Upload comprehensive report
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-report-ultra-robusto-${{ github.sha }}
          path: report.md
          retention-days: 30

      - name: ğŸ“± Success notification
        if: |
          needs.deploy-staging.result == 'success' || 
          needs.deploy-production.result == 'success'
        run: |
          echo "ğŸ‰ Pipeline ultra-robusto executado com sucesso!"
          echo "ğŸŒ URL: https://vytalle-estetica.vercel.app"
          echo "ğŸ“Š Coverage: DisponÃ­vel no Codecov"
          echo "ğŸ§ª E2E: ${{ needs.e2e-tests.result }}"
          echo "âš¡ Performance: ${{ needs.performance-tests.result }}"
          echo "ğŸ›¡ï¸ Security: Verificada"
          
      - name: ğŸš¨ Failure notification
        if: |
          needs.deploy-staging.result == 'failure' || 
          needs.deploy-production.result == 'failure'
        run: |
          echo "âŒ Pipeline falhou!"
          echo "Verifique os logs para mais detalhes."
          echo "ğŸ” Jobs com falha:"
          echo "- Quality Check: ${{ needs.quality-check.result }}"
          echo "- Unit Tests: ${{ needs.unit-tests.result }}"
          echo "- Build: ${{ needs.build.result }}"
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "- Performance Tests: ${{ needs.performance-tests.result }}"
          exit 1 