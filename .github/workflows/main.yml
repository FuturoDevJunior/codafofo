name: ğŸš€ Vytalle CI/CD Pipeline Ultra-Otimizado

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE.md'
      - '.github/REPOSITORY.md'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      full_test:
        description: 'Run full test suite including E2E'
        required: false
        default: false
        type: boolean
      performance_test:
        description: 'Run performance tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  NODE_ENV: production
  CI: true
  HUSKY: 0

jobs:
  # Setup e Cache
  setup:
    name: âš¡ Setup Otimizado
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
    
    steps:
      - name: ğŸ“¥ Checkout otimizado
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”‘ Gerar cache key
        id: cache-key
        run: |
          echo "key=vytalle-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/next.config.js') }}" >> $GITHUB_OUTPUT

      - name: ğŸ” Verificar deploy
        id: deploy-check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/tags/v*" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # Cache de DependÃªncias
  cache-deps:
    name: ğŸ“¦ Cache DependÃªncias
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 3
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache de dependÃªncias
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            vytalle-${{ runner.os }}-${{ env.NODE_VERSION }}-

      - name: ğŸ“¦ Instalar dependÃªncias
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          npm run install:deps
          npm cache clean --force

  # Qualidade e Testes Paralelos
  quality-check:
    name: ğŸ” Quality Check
    runs-on: ubuntu-latest
    needs: [setup, cache-deps]
    timeout-minutes: 10
    strategy:
      matrix:
        task: [lint, type-check, security]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ§¹ Lint
        if: matrix.task == 'lint'
        run: npm run lint

      - name: ğŸ” Type Check
        if: matrix.task == 'type-check'
        run: npm run type-check

      - name: ğŸ›¡ï¸ Security Audit
        if: matrix.task == 'security'
        run: npm audit --audit-level=high
        continue-on-error: true

  # Testes UnitÃ¡rios Otimizados
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [setup, cache-deps]
    timeout-minutes: 15
    strategy:
      matrix:
        node-version: ['18.x', '20.x']
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ§ª Executar testes unitÃ¡rios
        run: |
          npm run test:ci -- --coverage --reporter=verbose --reporter=json --outputFile=coverage-${{ matrix.node-version }}.json

      - name: ğŸ“Š Upload coverage
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v3
        with:
          file: coverage-${{ matrix.node-version }}.json
          flags: vytalle-unit-tests
          name: vytalle-coverage-${{ matrix.node-version }}
          fail_ci_if_error: false

  # Build Otimizado
  build:
    name: ğŸ—ï¸ Build Otimizado
    runs-on: ubuntu-latest
    needs: [setup, cache-deps, quality-check, unit-tests]
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o
        run: |
          npm run build
          npm run analyze

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            .next
            public
            package.json
            package-lock.json
            .next/analyze
          retention-days: 7
          compression-level: 9

      - name: ğŸ“Š Bundle analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-${{ github.sha }}
          path: .next/analyze/
          retention-days: 30

  # Testes E2E Paralelos
  e2e-tests:
    name: ğŸ§ª E2E Tests
    runs-on: ubuntu-latest
    needs: [setup, cache-deps, build]
    if: |
      always() && 
      (needs.setup.outputs.should-deploy == 'true' || 
       github.event.inputs.full_test == 'true')
    timeout-minutes: 20
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ğŸ­ Install Playwright
        run: npm run test:e2e:install

      - name: ğŸ§ª Run E2E tests (${{ matrix.browser }})
        run: |
          npm run test:e2e -- --project=${{ matrix.browser }} --reporter=html,json
        env:
          BASE_URL: https://vytalle-estetica.vercel.app

      - name: ğŸ“Š Upload E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}-${{ github.sha }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # Performance Tests
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [setup, cache-deps, build]
    if: |
      always() && 
      (needs.setup.outputs.should-deploy == 'true' || 
       github.event.inputs.performance_test == 'true')
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ğŸš€ Start application
        run: |
          npm start &
          sleep 30

      - name: âš¡ Lighthouse Performance
        run: |
          npm run performance:lighthouse
          npm run performance:budget

      - name: ğŸ“Š Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results-${{ github.sha }}
          path: |
            lighthouse-report.html
            lighthouse-performance.json
          retention-days: 30

  # Deploy Staging (AutomÃ¡tico)
  deploy-staging:
    name: ğŸŒ Deploy Staging
    runs-on: ubuntu-latest
    needs: [setup, build, e2e-tests, performance-tests]
    if: |
      always() && 
      needs.setup.outputs.should-deploy == 'true' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ğŸš€ Deploy to Vercel (Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ env.VERCEL_ORG_ID }}
          vercel-project-id: ${{ env.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: ğŸ” Health Check
        run: |
          sleep 30
          curl -f https://vytalle-estetica.vercel.app/api/health || echo "Health check failed"

      - name: ğŸ“± Notify success
        run: |
          echo "âœ… Deploy staging realizado com sucesso!"
          echo "ğŸŒ URL: https://vytalle-estetica.vercel.app"
          echo "ğŸ“Š Performance: DisponÃ­vel nos artifacts"

  # Deploy Production (Manual/Tags)
  deploy-production:
    name: ğŸ¯ Deploy Production
    runs-on: ubuntu-latest
    needs: [setup, build, e2e-tests, performance-tests]
    if: |
      always() && 
      needs.setup.outputs.should-deploy == 'true' &&
      ((github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') ||
       startsWith(github.ref, 'refs/tags/v'))
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ğŸš€ Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ env.VERCEL_ORG_ID }}
          vercel-project-id: ${{ env.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: ğŸ” Health Check
        run: |
          sleep 30
          curl -f https://vytalle-estetica.vercel.app/api/health || echo "Health check failed"

      - name: ğŸ·ï¸ Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Vytalle v${{ github.ref_name }}
          body: |
            ## ğŸš€ Vytalle EstÃ©tica - Release ${{ github.ref_name }}
            
            ### âœ¨ Novidades
            - Melhorias no sistema de cache
            - OtimizaÃ§Ãµes de performance
            - CorreÃ§Ãµes de bugs
            
            ### ğŸ”— Links
            - **ProduÃ§Ã£o:** https://vytalle-estetica.vercel.app
            - **DocumentaÃ§Ã£o:** https://github.com/FuturoDevJunior/codafofo
            
            ### ğŸ“Š MÃ©tricas
            - Testes: âœ… Passando
            - Coverage: >80%
            - Performance: Otimizada
            - E2E: âœ… Passando
            
            ### ğŸ§ª Testes Executados
            - Unit Tests: âœ…
            - E2E Tests: âœ…
            - Performance Tests: âœ…
            - Security Audit: âœ…
            
            ---
            *Desenvolvido com â¤ï¸ pela RET Consultoria*

      - name: ğŸ“± Notify success
        run: |
          echo "âœ… Deploy produÃ§Ã£o realizado com sucesso!"
          echo "ğŸŒ URL: https://vytalle-estetica.vercel.app"
          echo "ğŸ“Š Performance: DisponÃ­vel nos artifacts"

  # Database Migration (se necessÃ¡rio)
  db-migration:
    name: ğŸ—„ï¸ Database Migration
    runs-on: ubuntu-latest
    needs: [setup, deploy-staging, deploy-production]
    if: |
      always() && 
      (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restaurar cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¦ Instalar dependÃªncias (se necessÃ¡rio)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ—„ï¸ Run database migrations
        run: npm run db:migrate
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ğŸ“Š Database backup
        run: npm run db:backup
        continue-on-error: true

  # NotificaÃ§Ãµes e RelatÃ³rios Finais
  notify:
    name: ğŸ“¢ Notifications & Reports
    runs-on: ubuntu-latest
    needs: [setup, quality-check, unit-tests, build, e2e-tests, performance-tests, deploy-staging, deploy-production, db-migration]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“Š Generate summary report
        run: |
          echo "## ğŸš€ Vytalle CI/CD Pipeline Report" >> report.md
          echo "" >> report.md
          echo "### ğŸ“‹ Job Status:" >> report.md
          echo "- Quality Check: ${{ needs.quality-check.result }}" >> report.md
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> report.md
          echo "- Build: ${{ needs.build.result }}" >> report.md
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> report.md
          echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> report.md
          echo "- Deploy Staging: ${{ needs.deploy-staging.result }}" >> report.md
          echo "- Deploy Production: ${{ needs.deploy-production.result }}" >> report.md
          echo "- Database Migration: ${{ needs.db-migration.result }}" >> report.md
          echo "" >> report.md
          echo "### ğŸ”— Links:" >> report.md
          echo "- **Production:** https://vytalle-estetica.vercel.app" >> report.md
          echo "- **Repository:** https://github.com/FuturoDevJunior/codafofo" >> report.md
          echo "" >> report.md
          echo "### ğŸ“Š Artifacts:" >> report.md
          echo "- Build: build-artifacts-${{ github.sha }}" >> report.md
          echo "- Bundle Analysis: bundle-analysis-${{ github.sha }}" >> report.md
          echo "- E2E Results: e2e-results-*-${{ github.sha }}" >> report.md
          echo "- Performance: performance-results-${{ github.sha }}" >> report.md

      - name: ğŸ“¤ Upload report
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-report-${{ github.sha }}
          path: report.md
          retention-days: 30

      - name: ğŸ“± Success notification
        if: |
          needs.deploy-staging.result == 'success' || 
          needs.deploy-production.result == 'success'
        run: |
          echo "ğŸ‰ Pipeline executado com sucesso!"
          echo "ğŸŒ URL: https://vytalle-estetica.vercel.app"
          echo "ğŸ“Š Coverage: DisponÃ­vel no Codecov"
          echo "ğŸ§ª E2E: ${{ needs.e2e-tests.result }}"
          echo "âš¡ Performance: ${{ needs.performance-tests.result }}"
          
      - name: ğŸš¨ Failure notification
        if: |
          needs.deploy-staging.result == 'failure' || 
          needs.deploy-production.result == 'failure'
        run: |
          echo "âŒ Pipeline falhou!"
          echo "Verifique os logs para mais detalhes."
          exit 1 